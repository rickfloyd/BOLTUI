/**
 * @file Firestore Security Rules for AIQuantumCharts
 * @description This ruleset enforces a security model that prioritizes public readability for Forex and Crypto data,
 *   authenticated write access for these datasets, and strict user-ownership for dashboard configurations.
 *
 * @dataStructure
 *   /forex-data/{pairId}: Publicly readable Forex data, writeable by authenticated users.
 *   /crypto-data/{pairId}: Publicly readable Crypto data, writeable by authenticated users.
 *   /humanitarian-impact: Publicly readable and writeable (for prototyping).
 *   /users/{userId}/dashboardConfig: User-specific dashboard configurations, accessible only by the owner.
 *
 * @keySecurityDecisions
 *   - Forex and Crypto data are publicly readable to facilitate open access to trading information.
 *   - User listing is implicitly disallowed.
 *   - Default security posture for ambiguous relationships is strict owner-only access.
 *   - The humanitarian-impact collection is left open for read/write access to support rapid prototyping. This should be restricted in production.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows public read access to Forex data and write access to authenticated users.
     * @path /forex-data/{pairId}
     * @allow (get, list): Any user can read Forex data.
     * @allow (create, update, delete): Only authenticated users can modify Forex data.
     * @deny (create, update, delete): Unauthenticated users cannot modify Forex data.
     * @principle Allows public read and authenticated write access.
     */
    match /forex-data/{pairId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows public read access to Crypto data and write access to authenticated users.
     * @path /crypto-data/{pairId}
     * @allow (get, list): Any user can read Crypto data.
     * @allow (create, update, delete): Only authenticated users can modify Crypto data.
     * @deny (create, update, delete): Unauthenticated users cannot modify Crypto data.
     * @principle Allows public read and authenticated write access.
     */
    match /crypto-data/{pairId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows public read and write access to humanitarian impact data (for prototyping).
     * @path /humanitarian-impact
     * @allow (get, list, create, update, delete): Any user can read and write humanitarian impact data.
     * @principle Allows public read and write access.
     */
    match /humanitarian-impact {
      allow get, list, create, update, delete: if true;
    }

        /**
     * @description Enforces user-specific access to dashboard configurations.
     * @path /users/{userId}/dashboardConfig
     * @allow (get): Allows the owner to read their dashboard configuration.
     * @allow (list): Allows the owner to list their dashboard configurations.
     * @allow (create): Allows the owner to create their dashboard configuration.
     * @allow (update): Allows the owner to update their dashboard configuration.
     * @allow (delete): Allows the owner to delete their dashboard configuration.
     * @deny (get, list, create, update, delete): Denies access to any other user.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/dashboardConfig {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }
  }
}